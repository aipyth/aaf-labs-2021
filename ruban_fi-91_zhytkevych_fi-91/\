package indexer

import (
	"log"
	"regexp"

	"github.com/aipyth/aaf-labs-2021/ruban_fi-91_zhytkevych_fi-91/storage"
)

type Indexer interface {
	IndexDocument(collId int, document []byte)
	GetDocsByKeyword(word string) map[int][]int
	GetDocsByPrefix(word string) map[int][]int
	GetDocsByKeywords(word1 string, word2 string, dist int) map[int][]int
}

type IndexerBtree struct {
	btree *storage.Btree
}

func NewIndexer(storagePath string) *IndexerBtree {
	btree := storage.NewBtree(storagePath)
	return &IndexerBtree{
		btree: btree,
	}
}

func regexSplit(str string, reg string) []string {
	return regexp.MustCompile(reg).Split(str, -1)
}

func makeInvertedIndexes(words []string, docId int) map[string]map[int][]int {
	m := make(map[string]map[int][]int)
	for i, w := range words {
		log.Println(m[w])
		if m[w] == nil {
			val := make(map[int][]int)
			val[docId] = []int{i}
			continue
		}
		m[w][docId] = append(m[w][docId], int(i))
	}
	return m
}

func (i *IndexerBtree) IndexDocument(docId int, document []byte) {
	words := regexSplit(string(document), `[^a-zA-Z0-9_+]`)
	i.btree.AddIndexes(makeInvertedIndexes(words, docId))
}

func (i *IndexerBtree) GetDocsByKeyword(word string) map[int][]int {
	sheetEl, err := i.btree.Find(word)
	if err != nil {
		log.Println(err)
	}
	return sheetEl.Data
}
